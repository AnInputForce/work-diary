# Docker搭建Django+Mariadb环境

## 环境之“Docker-Mariadb”搭建

参考：在Mac中直接安装Maridb（不推荐），[Mac中MariaDB数据库的安装步骤](http://www.jb51.net/article/93202.htm)

### 下载Mariadb数据库镜像

```shell
docker pull mariadb
```

### 启动并配置DB

+ 映射数据库数据文件和配置文件
  + 新建~/mariadb/data 、~/mariadb/custom目录
  + -v ~/mariadb/data:/var/lib/mysql 映射数据文件出来
  +  -v ~/mariadb/custom:/etc/mysql/conf.d 映射配置文件出来
  + 指定数据库编码utf8mb4，参考：[mysql使用utf8mb4经验吐血总结](http://www.cnblogs.com/xiangcaiduoyidian/p/6210037.html)

```shell
$ mkdir -p ~/mariadb/data ~/mariadb/custom
$ docker run --name some-mariadb -v ~/mariadb/data:/var/lib/mysql   -v ~/mariadb/custom:/etc/mysql/conf.d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=1q2w -d mariadb:latest --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
```

### 测试验证

```shell
$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
77de3a6bf3fe        mariadb:latest      "docker-entrypoint..."   2 minutes ago       Up About a minute   0.0.0.0:3306->3306/tcp   some-mariadb
$ docker exec -it some-mariadb bash
root@77de3a6bf3fe:/# mysql -uroot -p1q2w
Welcome to the MariaDB monitor.  Commands end with ; or \g.
....
MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
3 rows in set (0.02 sec)
```

## 环境之“Docker-Django”搭建

很意外，翻了翻官方hub 镜像，有如下提示：

> This image is officially deprecated in favor of [the standard `python` image](https://hub.docker.com/_/python/);

大致意思是：这个镜像已被标准python镜像取代。该镜像不能直接带来Django环境，仅有的价值是提供一些Django依赖如mysql-client等。或许因为Django是APP级的，依赖于Project的requirements.txt，like this：

```shell
Django==1.11.3
MySQL-python
```

### 准备项目目录

```shell
$ mkdir -p ~/workspace/autodeploy && cd ~/workspace/autodeploy && mkdir z-dev z-pub
```

创建Dockerfile

直接使用Python2.7基础镜像，简单粗暴省事，适合想快速体验的孩子：

```dockerfile
# 基础镜像
FROM python:2.7
# 维护者信息
MAINTAINER kang.cunhua <kangcunhua@git.com.cn> 
# app 所在目录
WORKDIR /usr/src/web
ADD . /usr/src/web/
# 安装 app 所需依赖
RUN pip install --no-cache-dir -r requirements.txt 
```

### 创建requirements.txt

```shell
Django==1.11.3
MySQL-python
```

### 宿主机当前目录结构

```shell
$ tree
.
└── mysite
    ├── Dockerfile
    ├── db
    └── mysite
        └── requirements.txt
```

### Build镜像

```shell
docker build -t mydjango:latest .
```

### 运行&进入容器

```shell
ChinaDreams:workspace kangcunhua$ docker run --name web -it -p 8000:8000 -d mydjango:6.0 /bin/bash 
ChinaDreams:workspace kangcunhua$ docker exec web -it /bin/bash
```

### 验证环境

```shell
root@785a50fd228f:/usr/src/webapp/mysite/mysite# python --version
Python 2.7.13
root@785a50fd228f:/usr/src/webapp/mysite/mysite# python -m django --version
1.11.3
```

### 脚手架生成项目,copy出来

```shell
root@26ad1dfb070f:/usr/web# django-admin startproject autodeploy
root@26ad1dfb070f:/usr/web# python manage.py runserver 0:8000
root@26ad1dfb070f:/usr/web#exit
ChinaDreams:workspace kangcunhua$ docker cp web:/usr/web/autodeploy .
ChinaDreams:workspace kangcunhua$ tree

```

ChinaDreams:work-diary kangcunhua$ docker start web 
web
ChinaDreams:work-diary kangcunhua$ docker cp web:/usr/src/web/autodeploy.tar .

### 删除容器web

到此为止，此容器使命已经完成:生成项目初始化目录，删了即可；

```shell
docker rm web
```

### 新启容器web，挂载本地目录

本地目录优先覆盖容器目录，然后就实时同步了。所以一开始想把容器内某目录挂载出来，比较难。不如先copy出来，清空。然后从本地挂载上去。

```shell
docker run -it -p 8000:8000 -v ~/workspace:/usr/src/web  mydjango:latest /bin/bash 
```

### 运行，收获Django欢迎界面

It works！

欢庆吧，少年！

# 让我们做的更好

## 需要清醒的是，还有以下问题

- 我们此时还未使用到Mariadb，默认使用的是SqlLite数据库。接下来我们看看，从web容器中如何访问数据库；
- 我们默认使用的是Python的基础库，安装完django体积达到了惊人的近700M。
- 在docker pull安装镜像时，简直是龟速：由于众所周知的原因
- 在pip install 安装python模块是，也和龟速差不多了：由于众所周知的原因
- 我们能不能做的更好？答案是，必须能！

## 改进我们的Dockerfile

```dockerfile
# 基础镜像
FROM python:2.7-slim
# 维护者信息
MAINTAINER kang.cunhua <kangcunhua@git.com.cn> 
# app 所在目录
WORKDIR /usr/src/web
ADD . /usr/src/web
# 安装 app 所需依赖,做一些清理工作
RUN	buildDeps='gcc'; \ 
	deveDeps='mysql-client'; \ 
	set -x \
	&& cp /etc/apt/sources.list /etc/apt/sources.list.backup \
	&& mv sources.list /etc/apt/sources.list \
	&& apt-get update && apt-get install -y libmysqlclient-dev $buildDeps $deveDeps \
	# When using Python 2.7, please install IPython 5.x LTS Long Term Support version.
	&& pip install --no-cache-dir -r requirements.txt ipython==5.4.1 \
	-i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com  \
	&& rm -rf requirements.txt \
	# 移除gcc
	&& apt-get purge -y --auto-remove $buildDeps
```

注释已经不少了，对于新增的内容，还有些解释如下：

### sources.list

python的镜像使用的Debian，版本是jessie。找到了国内阿里云的加速镜像。

```shell
deb http://mirrors.aliyun.com/debian/ jessie main non-free contrib
deb http://mirrors.aliyun.com/debian/ jessie-proposed-updates main non-free contrib
deb-src http://mirrors.aliyun.com/debian/ jessie main non-free contrib
deb-src http://mirrors.aliyun.com/debian/ jessie-proposed-updates main non-free contrib
```

### mirrors.aliyun.com

同样使用的是阿里云的python pip源，安装时指定阿里云的源，并信任即可即可：

```shell
-i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com 
```

### 安装mysql-client

是因为“python manage.py dbshell”命令需要。此命令可以方便操作数据库，并自动加载了一些环境变量；开发环境还是用得到的；生成环境可以移除；若不安装，执行命令`python manage.py dbshell`时，会提示 

```shell
CommandError: You appear not to have the 'mysql' program installed or on your path.
```

### 安装和卸载gcc

因为MySQL-python的安装依赖gcc。网上也有说安装MySQL-devel包就能解决，暂不需要，也有提示把这些python-devel mysql-devel zlib-devel openssl-devel，都安装上就好了，太多了。只安装gcc，用完之后再卸载即可。

不安装gcc在build时编译MySQL-python报错：

```
unable to execute 'gcc': No such file or directory
error: command 'gcc' failed with exit status 1
```

### 安装ipython==5.4.1

是因为“python manage.py shell”进入交互式命令行会用到。不安装不方便。如果你安装了ipython 会自动用它们的界面。ipython是一套增强交互式Shell，用过的都说好；当然：生产环境可以不用安装。

## web容器访问Mariadb数据库

这时，就不得不提“--link”命令的使用了：

```shell
—link name:alias 
```

name是我们连接容器的名字,alias是link的别名。比如我们连接了数据库容器的web容器，就可以拿alias来配置数据库连接了。见下文：

### 启动容器时link数据库

不加这个link，你在web容器中，是连不上127.0.0.1:3306的。即使暴露了3306端口；

后台启动数据库(-d)

```shell
docker run --name some-mariadb -v ~/mariadb/data:/var/lib/mysql   -v ~/mariadb/custom:/etc/mysql/conf.d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=1q2w -d mariadb:latest --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
```

启动web容器link数据库容器

```shell
docker run --name web  --link=some-mariadb:db -it -p 8000:8000 -v ~/workspace:/usr/src/web  -d mydjango:latest /bin/bash 
```

### 修改配置

进入web容器，修改/autodeploy/autodeploy/settings.py中DATABASES配置:

```shell
docker exec -it web /bin/bash
```

注意'HOST': 'db'中，db就是我们在link中配置的别名。

```shell
DATABASES = {  
    'default': {  
        'ENGINE': 'django.db.backends.mysql',  
        'NAME': 'blog',  
        'USER': 'root',  
        'PASSWORD': '1q2w',  
        'HOST': 'db',  
        'PORT': '3306',  
    }  
}  
```

### 创建管理员

```shell
python manage.py createsuperuser 
```

### 启动web服务器

在web容器中，执行

```shell
 python manage.py runserver 0:8000
```

在宿主机上访问

```http
http://localhost:8000
```

就可以看到传说中的Django欢迎页：“It works！”。查看数据库，也有对应的表创建了。

登录后台，也可以看到对应自动生成好的页面

```shell
http://localhost:8000/admin
```

### MySql客户端推荐

对了，mac下MySQL或Mariadb客户端，推荐Sequel Pro，免费且超级好用，比Oracle官方的都好用。

# 能不能做的更好

答案是：能，必须能！比如我们可以引进docker compose来创建几个微服务，整合指挥整个系统架构；

dockercompose

```shell

```

待补

# 参考列表

## Mariadb在Docker下安装配置

参考：[Start a `mariadb` server instance](https://hub.docker.com/_/mariadb/)，强烈推荐。

参考： [docker（6）：使用dokcer 构建 mariadb 数据库](http://blog.csdn.net/freewebsys/article/details/53540615)

> 使用一个最简单的办法安装了mariadb。并且将数据放到了宿主机的/data/mysql/data 目录下面了。 方便数据备份,数据迁移，同时暴露了3306端口对外。 使用docker还是非常的方便的，比起yum安装配置简单多了。 配置文件也可以通过目录映射的方式修改。 而且完全的拆分了服务，存储，接口。真的是一个集装箱了。

## Mac tree命令

参考：[mac tree命令及参数](http://www.cnblogs.com/ayseeing/p/4097066.html)

> ```shell
> $ brew install tree
> ```