# Docker验证Centos离线安装Docker环境

[TOC]

# 序

​	条件有限，只有一台开发机，要跑5套子系统组成的项目群。还要有一些辅助和验证的系统要跑在这上面。从配置来看，要想顺畅开心地完成项目群基础环境支撑，考虑引入资源消耗1/200的神器Docker：更难得是丝毫不用担心环境污染、版本冲突、以及突然开发服务器搞崩溃了；

## 吐槽避免采坑

+ 实际上可能要跑的系统和辅助系统远超预计
+ ~~申请的是4C/8G的PC server，后来查命令是1C/2G，10G空间，果断申请扩容了~~
+ 边干边写：整了四周；期间无数次崩溃，~~还要应对乙方内部的质疑，~~不知道自己是如何坚持下来的

### 第一周折腾无实质交付

+ MacBook上docker环境起了CentOS7.2容器，在容器中模拟离线安装Docker环境（盗梦空间）
+ 安装很成功，按官方教程启动服务时，崩溃到怀疑人生：
  + 命令"systemctl start docker"报错："docker Failed to get D-Bus connection"
  + CentOS从7开始，安全考虑，容器内默认不加载D-Bus：直接影响就是systemctl不能起服务；
  + github支招：加容器特权参数 --privileged ，启动非常之慢，不建议踩坑；参考[链接](https://github.com/moby/moby/issues/7459)
  + Docker官方支招：自己编译带systemctl服务的镜像 [参考链接](https://forums.docker.com/t/any-simple-and-safe-way-to-start-services-on-centos7-systemd/5695/4)，
    + 然而我没能测试成功在容器中启动docker daemo
    + 其他服务没尝试，感兴趣的可自行研究
    + 放弃在容器中使用systemctl启动Docker镜像服务

### 第二周换Redhad7.2镜像

- 还是报同样的错误：直接报缺5~8个一级依赖包
- 后来分析不是CentOS和Redhad不同步，应该是甲方提供的CentOS源或系统优化或缺了一些默认的包；

### 第三周寄希望于甲方提供的内网源

- 结果挂的源是一个docker集群监控的源；甲方老师又忙。暂停修整了一周；

### 第四周重整旗鼓

再三协调之后，放弃等待甲方老师的支援。决定还是自己搞。不就是一些一级依赖么，补全就是！

~~主要是我方火力太猛：~~

+ ~~再不出活，无颜面对向兄弟们：虽然不上这些，采用笨办法也能干，但总归不忍~~
+ ~~再不交付，无法上得台面解释：~~
+ ~~自己选择的牛皮，哭着也要吹完，吹完美~~

搞定。想来想去，还是毛选里的那句话支撑了我：

自力更生，艰苦奋斗！

最近在看一行禅师的《佛陀传》，希望能从中汲取心灵的力量。《天龙八部》里扫地僧也曾说过：

> 只有佛法越高，慈悲之念越盛，武功绝技才能练得越我

或许我辈子工作中修行，也是这个道理！

## 采坑记

对，就是采坑。以下是从草稿中摘取的部分尝试：

| 编号 | 容器                                                         |
| ---- | ------------------------------------------------------------ |
| 1    | docker run -it --name dc7 ailyfeng/centos7.2.1511 /bin/bash  |
| 2    | docker run -it --name dc88 sssllc/centos7.2-jdk1.8  /bin/bash |
| 3    | docker run -it --name ct7 centos /bin/bash                   |
| 4    | docker run -it --privileged --name dc99 sssllc/centos7.2-jdk1.8 |
| 5    | docker build --rm -t centos:systemd . && docker run -it --name dr7 centos:systemd |
| 6    | docker run -it --name dr18 yjjy0921/redhat7.2 /bin/bash      |

### 几个搞定依赖包的有用命令

ldd应该是linux通用的命令；rpm和repotrack貌似是CentoOS的专有命令；

| 编号 | 命令      | 举例                                                | 作用                                                         |
| ---- | --------- | --------------------------------------------------- | ------------------------------------------------------------ |
| 1    | ldd       | ldd wkhtmltopdf                                     | not found的就是对应的依赖包不存在，适用于二进制包（wkhtmltopdf）的命令；而需要安装的命令（docker-ce）只能通过安装报错来捕获缺失的依赖了 |
| 2    | rpm -ql   | rpm -ql docker-ce                                   | 查看安装的时候有哪些命令在PATH下，用这些命令去启动           |
| 3    | repotrack | repotrack -a x86_64 -p /usr/local/yumrepo libgudev1 | 打包下载指定架构(X86_63)所有的依赖到指定目录                 |

## 思路：先验证再服务器落地

- 本地pull一个CentOS7.2的镜像
- 只下载Docker及其依赖不安装
- 安装验证
- 考虑用户及用户组赋权
- cp至服务器尝试



# 安装docker

## 内网Linux基础依赖

要安装Docker基础环境，必须满足：

- Linux内核必须大于3.10：登录内网服务器看了看，恰好3.10。够用，就不折腾了；
- 需要支持device-mapper：已支持

```shell
[root@prms tmp] uname -r
3.10.0-327.e17.x86_64
[root@prms tmp] ls -l /sys/class/misc/device-mapper
lrwxrwxrwx. 1 root root 0 May 20 16:17 /sys/class/misc/device-mapper -> ../../devices/virtual/misc/device-mapper
```

## 

## 环境模拟



```shell
yum --disablerepo=\* --enablerepo=centos7-media clean all			#清除缓存
yum --disablerepo=\* --enablerepo=centos7-media makecache			#缓存本地yum源包信息
yum --disablerepo=\* --enablerepo=centos7-media install  tigervnc			#使用镜像源安装软件

```



### 拉取镜像，创建repo目录

```shell
ChinaDreams:~ kangcunhua$ docker run -it --name dc88 sssllc/centos7.2-jdk1.8  /bin/bash
[root@7d935562e0ae /]# java -version
java version "1.8.0_111"
Java(TM) SE Runtime Environment (build 1.8.0_111-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)
[root@7d935562e0ae /]# yum repo list
Loaded plugins: fastestmirror, ovl
No such command: repo. Please use /usr/bin/yum --help
[root@7d935562e0ae /]# 
[root@7d935562e0ae /]# yum repolist
Loaded plugins: fastestmirror, ovl
Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast
Determining fastest mirrors
 * base: mirrors.sohu.com
 * extras: mirrors.sohu.com
 * updates: centos.ustc.edu.cn
repo id                                                             repo name                                                             status
!base/7/x86_64                                                      CentOS-7 - Base                                                       9007
!extras/7/x86_64                                                    CentOS-7 - Extras                                                      393
!updates/7/x86_64                                                   CentOS-7 - Updates                                                    2560
repolist: 11960
[root@7d935562e0ae home]# cd /usr/local/
root@7d935562e0ae local]# mkdir yumrepo

```

### 下载所需离线包

```shell
[root@7d935562e0ae local]# cd yumrepo/
[root@7d935562e0ae yumrepo]# yum install --downloadonly --downloaddir=/usr/local/yumrepo/ docker
```



### 安装createrepo

```shell
[root@7d935562e0ae yum.repos.d]# yum install createrepo -y 
```

### 新建docker.repo

```shell
[root@7d935562e0ae yum.repos.d]# pwd
/etc/yum.repos.d
[root@7d935562e0ae yum.repos.d]# vi docker.repo
```

**docker.repo**

```Shell
[docker-yum]
name=dockeryum
baseurl=file:///usr/local/yumrepo
enable=1
gpgcheck=0
```

### 生成repo索引

主要是将索引生成在/usr/local/yumrepo/repodata目录

```shell
[root@7d935562e0ae yum.repos.d]# createrepo /usr/local/yumrepo/
[root@7d935562e0ae yum.repos.d]# cd /usr/local/yumrepo/
[root@7d935562e0ae yumrepo]# ls
.....
docker-client-1.13.1-53.git774336d.el7.centos.x86_64.rpm        repodata
.....
```



### 安装docker

```shell
[root@7d935562e0ae yumrepo]# yum --disablerepo=\* --enablerepo=docker-yum install docker -y
[root@7d935562e0ae yumrepo]# docker -v
Docker version 1.13.1, build 774336d/1.13.1
```

### 启动docker守护进程

```shell
[root@7d935562e0ae /]# docker run hello-world
/usr/bin/docker-current: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?.
See '/usr/bin/docker-current run --help'.
[root@7d935562e0ae /]# service docker start
bash: service: command not found
[root@7d935562e0ae /]# systemctrl start docker 
bash: systemctrl: command not found
[root@7d935562e0ae /]# systemctl start docker 
Failed to get D-Bus connection: Operation not permitted
```



```shell
[root@7d935562e0ae /]# systemctl start docker 
Failed to get D-Bus connection: Operation not permitted
```





## docker Failed to get D-Bus connection 报错



## 知识点rpm -ql 软件包

> rpm -ql 软件包 查看安装的时候有哪些命令在PATH下，用这些命令去启动，这个是一种解决的方法

```shell
[root@9c676d901d7b bin]# rpm -ql docker-ce
/etc/udev/rules.d/80-docker.rules
/usr/bin/docker
/usr/bin/docker-containerd
/usr/bin/docker-containerd-ctr
/usr/bin/docker-containerd-shim
/usr/bin/docker-init
/usr/bin/docker-proxy
/usr/bin/docker-runc
/usr/bin/dockerd
/usr/lib/systemd/system/docker.service
/usr/share/bash-completion/completions/docker
```

# 安装Docker-CE

梳理思路，重来

- 选择centos7.2基础镜像
- 配置docker-ce源
- 下载不安装docker-ce及其依赖
- 配置本地源
- 指定本地源安装docker-ce
- 条件有限，就不容器中起docker服务了
- 进内网，验证

## 下载centos7.2基础镜像

```shell
ChinaDreams:docker-systemctl kangcunhua$ docker run -it --name dc18 sssllc/centos7.2-jdk1.8  /bin/bash
[root@557a4e0c3e7e /]#
```

## 配置docker-ce源

如果不配置docker-ce源，默认安装的是docker1.13。大概是两年前的版本了。后续docker官方将社区版本命名为docker-ce。所以安装新版本，还是要配置下yum源的：这里强烈建议配置国内的，速度快。

```shell
[root@557a4e0c3e7e /]# yum-config-manager --add-repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo
```

配置后， yum search docker-ce可以搜索到了。这时候就可以下载到指定位置：为了后续离线安装；

## 下载不安装：为了验证离线

```shell
[root@557a4e0c3e7e /]# cd /usr/local
[root@557a4e0c3e7e local]# mkdir yumrepo
[root@557a4e0c3e7e local]# yum install --downloadonly --downloaddir=/usr/local/yumrepo/ docker-ce
```

## 配置docker本地源

### 建立索引

 先安装本地repo索引创建工具，通过这个工具，建立索引：就是本地安装包所在目录下的repodata目录；

```shell
[root@557a4e0c3e7e yumrepo]# yum install createrepo -y
[root@557a4e0c3e7e yumrepo]# createrepo /usr/local/yumrepo/
```

### 创建源文件docker.repo

```shell
[root@557a4e0c3e7e yumrepo]# cd /etc/yum.repos.d
[root@557a4e0c3e7e yum.repos.d]# vi docker.repo
[root@557a4e0c3e7e yum.repos.d]# more docker.repo 
[docker-yum]
name=dockeryum
baseurl=file:///usr/local/yumrepo
enable=1
gpgcheck=0
```

## 模拟离线安装

```shell
yum --disablerepo=\* --enablerepo=docker-yum install docker-ce -y
```

## 验证安装成功

```shell
[root@557a4e0c3e7e yum.repos.d]# docker -v
Docker version 18.03.1-ce, build 9ee9f40
```



**启动dockerd，报错记录**

```shell
[root@557a4e0c3e7e /]# docker -v
Docker version 18.03.1-ce, build 9ee9f40
[root@557a4e0c3e7e /]# /usr/bin/dockerd 
INFO[2018-05-22T11:55:22.811053980Z] libcontainerd: started new docker-containerd process  pid=53
INFO[0000] starting containerd                           module=containerd revision=773c489c9c1b21a6d78b5c538cd395416ec50f88 version=v1.0.3
ERRO[0000] failed to change OOM score to -500            error="write /proc/53/oom_score_adj: permission denied" module=containerd
INFO[0000] loading plugin "io.containerd.content.v1.content"...  module=containerd type=io.containerd.content.v1
INFO[0000] loading plugin "io.containerd.snapshotter.v1.btrfs"...  module=containerd type=io.containerd.snapshotter.v1
WARN[0000] failed to load plugin io.containerd.snapshotter.v1.btrfs  error="path /var/lib/docker/containerd/daemon/io.containerd.snapshotter.v1.btrfs must be a btrfs filesystem to be used with the btrfs snapshotter" module=containerd
INFO[0000] loading plugin "io.containerd.snapshotter.v1.overlayfs"...  module=containerd type=io.containerd.snapshotter.v1
INFO[0000] loading plugin "io.containerd.metadata.v1.bolt"...  module=containerd type=io.containerd.metadata.v1
WARN[0000] could not use snapshotter btrfs in metadata plugin  error="path /var/lib/docker/containerd/daemon/io.containerd.snapshotter.v1.btrfs must be a btrfs filesystem to be used with the btrfs snapshotter" module="containerd/io.containerd.metadata.v1.bolt"
INFO[0000] loading plugin "io.containerd.differ.v1.walking"...  module=containerd type=io.containerd.differ.v1
INFO[0000] loading plugin "io.containerd.gc.v1.scheduler"...  module=containerd type=io.containerd.gc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.containers"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.content"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.diff"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.events"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.healthcheck"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.images"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.leases"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.namespaces"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.snapshots"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.monitor.v1.cgroups"...  module=containerd type=io.containerd.monitor.v1
INFO[0000] loading plugin "io.containerd.runtime.v1.linux"...  module=containerd type=io.containerd.runtime.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.tasks"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.version"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] loading plugin "io.containerd.grpc.v1.introspection"...  module=containerd type=io.containerd.grpc.v1
INFO[0000] serving...                                    address="/var/run/docker/containerd/docker-containerd-debug.sock" module="containerd/debug"
INFO[0000] serving...                                    address="/var/run/docker/containerd/docker-containerd.sock" module="containerd/grpc"
INFO[0000] containerd successfully booted in 0.029058s   module=containerd
ERRO[2018-05-22T11:55:23.265326880Z] 'overlay2' is not supported over aufs        
ERRO[2018-05-22T11:55:23.268621280Z] AUFS is not supported over aufs              
ERRO[2018-05-22T11:55:23.274969080Z] 'overlay' is not supported over aufs         
WARN[2018-05-22T11:55:23.279135680Z] Unable to setup quota: operation not permitted
 
INFO[2018-05-22T11:55:23.337985980Z] Graph migration to content-addressability took 0.00 seconds 
INFO[2018-05-22T11:55:23.343461280Z] Loading containers: start.                   
WARN[2018-05-22T11:55:23.349000880Z] Running modprobe bridge br_netfilter failed with message: , error: exit status 1 
WARN[2018-05-22T11:55:23.351503180Z] Running modprobe nf_nat failed with message: ``, error: exit status 1 
WARN[2018-05-22T11:55:23.353577680Z] Running modprobe xt_conntrack failed with message: ``, error: exit status 1 
Error starting daemon: Error initializing network controller: error obtaining controller instance: failed to create NAT chain DOCKER: iptables failed: iptables -t nat -N DOCKER: iptables v1.4.21: can't initialize iptables table `nat': Permission denied (you must be root)
Perhaps iptables or your kernel needs to be upgraded.
 (exit status 3)

```



## Copy资源出来

```shell
ChinaDreams:Desktop kangcunhua$ docker cp dc18:/usr/local/yumrepo .
ChinaDreams:Desktop kangcunhua$ docker cp dc18:/etc/yum.repos.d/docker.repo .
```



# 内网离线实战

copy资源到内网，通过ssh将依赖包传到服务器

yumrepo放置到/usr/local/目录下

docker.repo放置到/etc/yum.repo.d/目录下

## 验证docker本地源

```shell
yum repolist #可以成功查看到docker-yum
```

## 离线安装

```shell
yum --disablerepo=\* --enablerepo=docker-yum install docker-ce -y
```

## 报错

```shell
Error: Package: systemd-sysv-219-19.el7.x86_64 (@anaconda)
           Requires: systemd = 219-19.el7
           Removing: systemd-219-19.el7.x86_64 (@anaconda)
               systemd = 219-19.el7
           Updated By: systemd-219-42.el7_4.4.x86_64 (localyum)
               systemd = 219-42.el7_4.4
Error: Package: dracut-network-033-359.el7.x86_64 (@anaconda)
           Requires: dracut = 033-359.el7
           Removing: dracut-033-359.el7.x86_64 (@anaconda)
               dracut = 033-359.el7
           Updated By: dracut-033-502.el7.x86_64 (localyum)
               dracut = 033-502.el7
Error: Package: libgudev1-219-19.el7.x86_64 (@anaconda)
           Requires: systemd-libs = 219-19.el7
           Removing: systemd-libs-219-19.el7.x86_64 (@anaconda)
               systemd-libs = 219-19.el7
           Updated By: systemd-libs-219-42.el7_4.4.x86_64 (localyum)
               systemd-libs = 219-42.el7_4.4
Error: Package: dracut-config-rescue-033-359.el7.x86_64 (@anaconda)
           Requires: dracut = 033-359.el7
           Removing: dracut-033-359.el7.x86_64 (@anaconda)
               dracut = 033-359.el7
           Updated By: dracut-033-502.el7.x86_64 (localyum)
               dracut = 033-502.el7
Error: Package: systemd-python-219-19.el7.x86_64 (@anaconda)
           Requires: systemd = 219-19.el7
           Removing: systemd-219-19.el7.x86_64 (@anaconda)
               systemd = 219-19.el7
           Updated By: systemd-219-42.el7_4.4.x86_64 (localyum)
               systemd = 219-42.el7_4.4
 You could try using --skip-broken to work around the problem
 You could try running: rpm -Va --nofiles --nodigest
```



# 解决依赖

```shell
ChinaDreams:~ kangcunhua$ docker start dc7
dc7
ChinaDreams:~ kangcunhua$ docker exec -it dc7 /bin/bash
ChinaDreams:~ kangcunhua$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

yum clean all
yum makecache
repotrack -a x86_64 -p /usr/local/yumrepo libgudev1
repotrack -a x86_64 -p /usr/local/yumrepo systemd-sysv
repotrack -a x86_64 -p /usr/local/yumrepo docker-ce


repotrack -a x86_64 -p /usr/local/yumrepo glibc-2.17-105.e
repotrack -a x86_64 -p /usr/local/yumrepo docker-ce
repotrack -a x86_64 -p /usr/local/yumrepo docker-ce
repotrack -a x86_64 -p /usr/local/yumrepo docker-ce


yum --disablerepo=\* --enablerepo=docker-yum install docker -y
```

## 再次尝试

```shell
Error: Package: systemd-sysv-219-19.el7.x86_64 (@anaconda)
           Requires: systemd = 219-19.el7
           Removing: systemd-219-19.el7.x86_64 (@anaconda)
               systemd = 219-19.el7
           Updated By: systemd-219-42.el7_4.4.x86_64 (localyum)
               systemd = 219-42.el7_4.4
Error: Package: dracut-network-033-359.el7.x86_64 (@anaconda)
           Requires: dracut = 033-359.el7
           Removing: dracut-033-359.el7.x86_64 (@anaconda)
               dracut = 033-359.el7
           Updated By: dracut-033-502.el7.x86_64 (localyum)
               dracut = 033-502.el7
Error: Package: libgudev1-219-19.el7.x86_64 (@anaconda)
           Requires: systemd-libs = 219-19.el7
           Removing: systemd-libs-219-19.el7.x86_64 (@anaconda)
               systemd-libs = 219-19.el7
           Updated By: systemd-libs-219-42.el7_4.4.x86_64 (localyum)
               systemd-libs = 219-42.el7_4.4
Error: Package: dracut-config-rescue-033-359.el7.x86_64 (@anaconda)
           Requires: dracut = 033-359.el7
           Removing: dracut-033-359.el7.x86_64 (@anaconda)
               dracut = 033-359.el7
           Updated By: dracut-033-502.el7.x86_64 (localyum)
               dracut = 033-502.el7
Error: Package: systemd-python-219-19.el7.x86_64 (@anaconda)
           Requires: systemd = 219-19.el7
           Removing: systemd-219-19.el7.x86_64 (@anaconda)
               systemd = 219-19.el7
           Updated By: systemd-219-42.el7_4.4.x86_64 (localyum)
               systemd = 219-42.el7_4.4

repotrack -a x86_64 -p /usr/local/yumrepo systemd-sysv
repotrack -a x86_64 -p /usr/local/yumrepo dracut-network
repotrack -a x86_64 -p /usr/local/yumrepo libgudev1
repotrack -a x86_64 -p /usr/local/yumrepo dracut-config-rescue
repotrack -a x86_64 -p /usr/local/yumrepo systemd-python

repotrack -a x86_64 -p /usr/local/yumrepo libstdc++
repotrack -a x86_64 -p /usr/local/yumrepo glibc-headers
repotrack -a x86_64 -p /usr/local/yumrepo pcre-devel
repotrack -a x86_64 -p /usr/local/yumrepo gcc-c++
repotrack -a x86_64 -p /usr/local/yumrepo glibc-devel

repotrack -a x86_64 -p /usr/local/yumrepo libtool-ltdl

repotrack -a x86_64 -p /usr/local/yumrepo libselinux-devel
repotrack -a x86_64 -p /usr/local/yumrepo libsepol-devel



```



# 安装和配置用户权限

## 验证

```shell
docker -v
```

启动服务



## 安装docker-compose

又被坑了：docker for Mac、docker for windows 安装完都自带docker-compose，linux版本的docker-ce居然不带。想起来离线安装各种坑就头大，网上查了半天[资料](https://www.jianshu.com/p/10d476c5ade1)，居然是个python工具，要先安装pip，o No！只好翻到github，看看能不能源码编译安装。结果看到有[release的下载](https://github.com/docker/compose/releases)，猜想可以直接使用。后来用下载后的文件百度，果然翻到一篇[指南](https://www.cnblogs.com/52fhy/p/5991344.html)，可以这样搞：

> 方法四：离线安装
>
> 下载docker-compose-Linux-x86_64，然后重新命名添加可执行权限即可：

```shell
ChinaDreams:Desktop kangcunhua$ docker cp ./docker-compose-Linux-x86_64.dms dc18:/usr/local/bin/docker-compose
```

进入容器

```shell
[root@557a4e0c3e7e /]# cd /usr/local/bin/
[root@557a4e0c3e7e bin]# ls
docker-compose
[root@557a4e0c3e7e bin]# chmod +x /usr/local/bin/docker-compose
[root@557a4e0c3e7e bin]# docker-compose -v
docker-compose version 1.21.2, build a133471
```



# 参考

## 直接安装rpm包

> 可以的，直接敲“rpm -ivh 包名”但是有些rpm包是有依赖性的，可以在命令尾端添加“--force --nodeps”，“--force”指强制“，”--nodeps“指不查找依赖性
>
> 比如”rpm -ivh *.rpm --force —nodeps“，同时，也可以使用yum命令，会自动解决包依赖的关系，能便于管理大量系统的更新问题，建议使用yum

## 容器特权--privileged

> **Runtime privilege, Linux capabilities, and LXC configuration**
>
> --cap-add : Add Linux capabilities
>
> --cap-drop : Drop Linux capabilities
>
> --privileged=false : Give extended privileges to this container
>
> --device=[] : Allows you to run devices inside the container without the --privileged flag.
>
> --lxc-conf=[] : (lxc exec-driver only) Add custom lxc options --lxc-conf="lxc.cgroup.cpuset.cpus = 0,1"
>
> 默认情况下，Docker的容器是没有特权的，例如不能在容器中再启动一个容器。这是因为默认情况下容器是不能访问任何其它设备的。但是通过"privileged"，容器就拥有了访问任何其它设备的权限。



我尝试了下，启动非常之慢

```shell
ChinaDreams:~ kangcunhua$ docker run -it --privileged --name dc99 sssllc/centos7.2-jdk1.8  /usr/sbin/init

Welcome to CentOS Linux 7 (Core)!

[  OK  ] Reached target Swap.
[  OK  ] Created slice Root Slice.
[  OK  ] Listening on udev Control Socket.
[  OK  ] Reached target Encrypted Volumes.
[  OK  ] Listening on udev Kernel Socket.
[  OK  ] Listening on Delayed Shutdown Socket.
[  OK  ] Listening on /dev/initctl Compatibility Named Pipe.
[  OK  ] Reached target Remote File Systems.
[  OK  ] Created slice User and Session Slice.
[  OK  ] Created slice System Slice.
[  OK  ] Created slice system-serial\x2dgetty.slice.
[  OK  ] Reached target Slices.
[  OK  ] Listening on Journal Socket.
         Mounting Debug File System...
         Starting Journal Service...
         Mounting FUSE Control File System...
         Starting Apply Kernel Variables...
         Starting Create Static Device Nodes in /dev...
         Mounting Huge Pages File System...
         Starting Setup Virtual Console...
[  OK  ] Created slice system-getty.slice.
         Starting Remount Root and Kernel File Systems...
[  OK  ] Reached target Paths.
[  OK  ] Mounted FUSE Control File System.
[  OK  ] Mounted Debug File System.
[  OK  ] Mounted Huge Pages File System.
[  OK  ] Started Apply Kernel Variables.
[  OK  ] Started Setup Virtual Console.
[  OK  ] Started Create Static Device Nodes in /dev.
         Starting udev Kernel Device Manager...
[  OK  ] Started Journal Service.
[  OK  ] Started udev Kernel Device Manager.
[FAILED] Failed to start Remount Root and Kernel File Systems.
See 'systemctl status systemd-remount-fs.service' for details.
[  OK  ] Reached target Local File Systems (Pre).
         Starting Rebuild Hardware Database...
         Starting Load/Save Random Seed...
         Starting Flush Journal to Persistent Storage...
[  OK  ] Reached target Local File Systems.
         Starting Rebuild Journal Catalog...
[  OK  ] Started Flush Journal to Persistent Storage.
         Starting Create Volatile Files and Directories...
[  OK  ] Started Load/Save Random Seed.
[  OK  ] Started Rebuild Journal Catalog.
[  OK  ] Started Create Volatile Files and Directories.
         Starting Update UTMP about System Boot/Shutdown...
[  OK  ] Started Update UTMP about System Boot/Shutdown.
[  OK  ] Started Rebuild Hardware Database.
         Starting udev Coldplug all Devices...
         Starting Update is Completed...
[  OK  ] Started Update is Completed.
[  OK  ] Started udev Coldplug all Devices.
[  OK  ] Reached target System Initialization.
[  OK  ] Reached target Timers.
[  OK  ] Listening on D-Bus System Message Bus Socket.
[  OK  ] Reached target Sockets.
[  OK  ] Reached target Basic System.
         Starting LSB: Supports the direct execution of binary formats....
         Starting Permit User Sessions...
[  OK  ] Started D-Bus System Message Bus.
         Starting D-Bus System Message Bus...
         Starting Login Service...
[  OK  ] Started Permit User Sessions.
         Starting Cleanup of Temporary Directories...
[  OK  ] Started Getty on tty1.
         Starting Getty on tty1...
[  OK  ] Started Cleanup of Temporary Directories.
[  OK  ] Started Login Service.
[  OK  ] Started LSB: Supports the direct execution of binary formats..
[ TIME ] Timed out waiting for device dev-ttyS0.device.
[DEPEND] Dependency failed for Serial Getty on ttyS0.
[  OK  ] Reached target Login Prompts.
[  OK  ] Reached target Multi-User System.
         Starting Update UTMP about System Runlevel Changes...
[  OK  ] Started Update UTMP about System Runlevel Changes.
^C^C^C^C^C^Cc\c/

```



+ [CentOS 安装 Docker CE](https://yeasy.gitbooks.io/docker_practice/content/install/centos.html)

```shell
$ sudo yum-config-manager \
    --add-repo \
    https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo
$ sudo yum-config-manager --enable docker-ce-edge
$ sudo yum makecache fast
$ sudo yum install docker-ce
```

